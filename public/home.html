<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>POS – Product System</title>
    <style>
        :root {
            --card-bg: #fff;
            --muted: #666;
            --brand: #28a745;
            --brand2: #2563eb;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f7f7f7;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 420px;
            margin: auto;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .08);
        }

        h1,
        h2 {
            margin: 8px 0;
            text-align: center;
        }

        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
        }

        .info p {
            margin: 6px 0;
        }

        .product-list {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
            border: 1px solid #ececec;
            border-radius: 10px;
            padding: 10px;
            background: #fafafa;
        }

        .name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .price {
            color: var(--muted);
            font-size: 14px;
        }

        .controls {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .controls button {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: #fff;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
        }

        .controls input {
            width: 64px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 8px;
            text-align: center;
            font-size: 16px;
        }

        .totals {
            margin-top: 12px;
            text-align: center;
        }

        .buy {
            width: 100%;
            padding: 12px;
            background: var(--brand);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 8px;
        }

        .buy:disabled {
            background: #aaa;
            cursor: not-allowed;
        }

        .links {
            text-align: center;
            margin-top: 14px;
        }

        .links a {
            color: var(--brand2);
            text-decoration: none;
            margin: 0 6px;
        }

        .links a:hover {
            text-decoration: underline;
        }

        .toast {
            position: fixed;
            left: 50%;
            top: 16px;
            transform: translateX(-50%);
            background: #111;
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            pointer-events: none;
            transition: opacity .25s;
            box-shadow: 0 6px 18px rgba(0, 0, 0, .2);
            z-index: 9999
        }

        .toast.show {
            opacity: 1
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>User Balance</h1>

        <select id="userSelect" aria-label="Select user">
            <option value="">Select a user</option>
        </select>

        <div class="info">
            <p><strong>Name:</strong> <span id="userName">—</span></p>
            <p><strong>Balance:</strong> <span id="userBalance">—</span></p>
        </div>

        <h2>Products</h2>
        <div id="productList" class="product-list" aria-live="polite"></div>

        <div class="totals">
            <p>Total: <strong><span id="totalPrice">0</span></strong></p>
            <p>Updated Balance: <strong><span id="updatedBalance">—</span></strong></p>
        </div>

        <button id="buyButton" class="buy" disabled>Buy Products</button>
    </div>

    <p class="links">
        <a href="/people_admin.html">Manage People</a> •
        <a href="/products_admin.html">View Products</a> •
        <a href="/team.html">Team POS</a> •
        <a href="/team_people_admin.html">Manage Team People</a> •
        <a href="/team_products_admin.html">View Team Products</a> •
        <a href="/transactions_admin.html">Transactions</a> •
        <a href="/reports_admin.html">Reports</a>
    </p>

    <div id="toast" class="toast" role="status" aria-live="polite">Purchase recorded</div>

    <script>
        const serverUrl = location.origin;
        const $ = (id) => document.getElementById(id);
        const safeId = (s) => s.toLowerCase().replace(/[^a-z0-9]+/g, '_');

        let selectedUser = '';
        let balance = 0;
        let products = {};
        let quantities = {};

        function showToast(msg = 'Purchase recorded') {
            const t = $('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 1200);
        }

        async function loadUsers() {
            const res = await fetch(serverUrl + '/people');
            const users = await res.json();
            const sel = $('userSelect');
            sel.textContent = '';
            const def = document.createElement('option');
            def.value = ''; def.textContent = 'Select a user';
            sel.appendChild(def);
            Object.keys(users).sort((a, b) => a.localeCompare(b)).forEach(name => {
                const opt = document.createElement('option');
                opt.value = name; opt.textContent = name;
                sel.appendChild(opt);
            });
        }

        async function loadProducts() {
            const res = await fetch(serverUrl + '/products');
            products = await res.json();

            const list = $('productList');
            list.textContent = '';
            quantities = {};

            Object.keys(products).sort((a, b) => a.localeCompare(b)).forEach(name => {
                const price = products[name].price || 0;
                const row = document.createElement('div'); row.className = 'row';

                const left = document.createElement('div');
                const n = document.createElement('div'); n.className = 'name'; n.textContent = name;
                const p = document.createElement('div'); p.className = 'price'; p.textContent = `Price: ${price}`;
                left.append(n, p);

                const controls = document.createElement('div'); controls.className = 'controls';
                const minus = document.createElement('button'); minus.type = 'button'; minus.setAttribute('aria-label', `Decrease ${name}`); minus.textContent = '−';
                const input = document.createElement('input'); input.autocomplete = 'off'; input.type = 'number'; input.min = '0'; input.step = '1'; input.value = '0'; input.id = 'q_' + safeId(name);
                const plus = document.createElement('button'); plus.type = 'button'; plus.setAttribute('aria-label', `Increase ${name}`); plus.textContent = '+';

                function setQty(val) {
                    const v = Math.max(0, Number(val) || 0);
                    input.value = String(v);
                    quantities[name] = v;
                    updateTotals();
                }
                minus.addEventListener('click', () => setQty(Number(input.value) - 1));
                plus.addEventListener('click', () => setQty(Number(input.value) + 1));
                input.addEventListener('input', () => setQty(input.value));

                controls.append(minus, input, plus);
                row.append(left, controls);
                list.appendChild(row);

                quantities[name] = 0;
            });

            updateTotals();
            const firstInput = list.querySelector('.controls input');
            if (firstInput) firstInput.focus({ preventScroll: true });
        }

        $('userSelect').addEventListener('change', async (e) => {
            const name = e.target.value;
            if (!name) {
                selectedUser = ''; balance = 0;
                $('userName').textContent = '—';
                $('userBalance').textContent = '—';
                updateTotals();
                return;
            }
            const res = await fetch(serverUrl + '/people/' + encodeURIComponent(name));
            if (res.ok) {
                const data = await res.json();
                selectedUser = name;
                balance = data[name] ?? 0;
                $('userName').textContent = name;
                $('userBalance').textContent = balance;
            } else {
                selectedUser = ''; balance = 0;
                $('userName').textContent = '—';
                $('userBalance').textContent = '—';
            }
            updateTotals();
        });

        function updateTotals() {
            let total = 0;
            for (const [name, q] of Object.entries(quantities)) {
                const qty = Math.max(0, Number(q) || 0);
                const price = (products[name]?.price) || 0;
                total += qty * price;
            }
            $('totalPrice').textContent = total;
            const after = selectedUser ? (balance - total) : null;
            $('updatedBalance').textContent = (after === null) ? '—' : (after >= 0 ? after : 'Insufficient');
            $('buyButton').disabled = !selectedUser || total <= 0 || (after !== null && after < 0);
        }

        function resetForNextSale() {
            for (const n of Object.keys(quantities)) quantities[n] = 0;
            document.querySelectorAll('.controls input').forEach(inp => { inp.value = '0'; });
            updateTotals();
            const firstInput = document.querySelector('.controls input');
            if (firstInput) firstInput.focus({ preventScroll: true });
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showToast();
        }

        document.getElementById('buyButton').addEventListener('click', async () => {
            const items = {};
            for (const [name, q] of Object.entries(quantities)) {
                const qty = Math.max(0, Number(q) || 0);
                if (qty > 0) items[name] = qty;
            }
            if (!selectedUser || Object.keys(items).length === 0) return;

            const res = await fetch(serverUrl + '/order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: selectedUser, items })
            });
            if (res.ok) {
                const j = await res.json();
                balance = j.balance;
                $('userBalance').textContent = balance;
                resetForNextSale();
            } else {
                console.error('Order failed', await res.text());
            }
        });

        loadUsers();
        loadProducts();
    </script>
</body>

</html>