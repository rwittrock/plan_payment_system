<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>POS – Product System</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#131a33;
      --muted:#9aa2b2;
      --text:#e7ecf6;
      --accent:#22c55e;
      --accent-pressed:#16a34a;
      --outline:#263157;
      --row:#0f1530;
      --link:#60a5fa;
      --danger:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg, #0b1020 0%, #0b1020 40%, #0c1226 100%);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    .app{
      min-height:100%;
      display:flex; flex-direction:column;
      padding:16px;
      padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 92px); /* room for sticky bar */
      gap:12px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--outline);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .header{
      padding:16px 16px 10px 16px;
      border-bottom:1px solid var(--outline);
    }
    .header h1{
      font-size:20px; margin:0 0 10px 0; text-align:center; font-weight:700;
    }
    .select{
      width:100%;
      background:#0d1430;
      color:var(--text);
      border:1px solid var(--outline);
      border-radius:10px;
      padding:14px 12px;
      font-size:16px;
      appearance:none;
    }
    .balance{
      padding:10px 16px 16px 16px;
      display:flex; justify-content:space-between; align-items:center;
      font-size:14px; color:var(--muted);
    }
    .balance strong{ color:var(--text); font-size:16px; }

    .list{
      max-height: 56vh; /* scrolls nicely under sticky footer */
      overflow:auto;
      padding:8px;
      display:flex; flex-direction:column; gap:8px;
      background:linear-gradient(180deg, #0c1128 0%, #0a1129 100%);
    }

    .row{
      background:var(--row);
      border:1px solid var(--outline);
      border-radius:12px;
      padding:10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px; align-items:center;
    }
    .name{ font-size:15px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .price{ font-size:13px; color:var(--muted); margin-top:2px; }

    .controls{ display:flex; align-items:center; gap:8px; }
    .btn{
      min-width:44px; min-height:44px;
      display:inline-flex; align-items:center; justify-content:center;
      font-size:22px; font-weight:700;
      background:#0e1634; color:var(--text);
      border:1px solid var(--outline);
      border-radius:12px;
      touch-action:manipulation;
    }
    .qty{
      width:76px; height:44px;
      text-align:center; font-size:18px; font-weight:700;
      background:#0c1430; color:var(--text);
      border:1px solid var(--outline);
      border-radius:12px;
    }

    .footer{
      position:fixed; left:0; right:0; bottom:0;
      padding:12px;
      padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 12px);
      background: rgba(10,15,35,.9);
      backdrop-filter: blur(12px);
      border-top:1px solid var(--outline);
      display:flex; gap:10px; align-items:center;
    }
    .totalBox{
      flex:1;
      background:#0d1430; border:1px solid var(--outline);
      border-radius:12px; padding:10px 12px;
      display:flex; flex-direction:column; gap:2px;
      min-height:56px;
    }
    .totalBox .label{ color:var(--muted); font-size:12px;}
    .totalBox .value{ font-size:18px; font-weight:800;}
    .buy{
      flex:1.1;
      background:var(--accent); color:#04150a;
      border:none; border-radius:14px;
      font-weight:900; font-size:16px;
      min-height:56px;
      box-shadow: 0 10px 18px rgba(34,197,94,.25);
      touch-action:manipulation;
    }
    .buy:disabled{
      background:#1f2937; color:#8a94a7; box-shadow:none; cursor:not-allowed;
    }
    .links{
      text-align:center; font-size:14px; color:var(--muted);
    }
    .links a{ color:var(--link); text-decoration:none; margin:0 6px;}
    .links a:active{ color:#93c5fd }

    .toast{
      position:fixed; left:50%; top:16px; transform:translateX(-50%);
      background:#0b122b; color:var(--text);
      border:1px solid var(--outline);
      padding:10px 14px; border-radius:12px;
      font-size:14px; opacity:0; pointer-events:none;
      transition:opacity .25s ease; z-index:9999;
      box-shadow:var(--shadow);
    }
    .toast.show{ opacity:1; }

    @media (prefers-reduced-motion: reduce) {
      .toast{ transition:none }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="header">
        <h1>POS Checkout</h1>
        <select id="userSelect" class="select" aria-label="Select user">
          <option value="">Select a user</option>
        </select>
      </div>
      <div class="balance">
        <div><span style="color:var(--muted)">Name:</span> <strong id="userName">—</strong></div>
        <div><span style="color:var(--muted)">Balance:</span> <strong id="userBalance">—</strong></div>
      </div>
      <div id="productList" class="list" aria-live="polite"></div>
    </div>

    <div class="links">
      <a href="/people_admin.html">Manage People</a> •
      <a href="/products_admin.html">Manage Products</a> •
      <a href="/team.html">Team POS</a> •
      <a href="/team_people_admin.html">Manage Team People</a> •
      <a href="/team_products_admin.html">Manage Team Products</a> •
      <a href="/transactions_admin.html">Transactions</a> •
      <a href="/reports_admin.html">Reports</a>
    </div>
  </div>

  <!-- Sticky checkout bar -->
  <div class="footer">
    <div class="totalBox">
      <div class="label">Total / Updated balance</div>
      <div class="value"><span id="totalPrice">0</span> • <span id="updatedBalance">—</span></div>
    </div>
    <button id="buyButton" class="buy" disabled>Buy</button>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">Purchase recorded</div>

<script>
  const serverUrl = location.origin;
  const $ = (id) => document.getElementById(id);
  const safeId = (s) => s.toLowerCase().replace(/[^a-z0-9]+/g,'_');

  let selectedUser = '';
  let balance = 0;
  let products = {};
  let quantities = {};

  function showToast(msg='Purchase recorded') {
    const t = $('toast'); t.textContent = msg; t.classList.add('show');
    setTimeout(()=> t.classList.remove('show'), 1100);
  }

  async function loadUsers() {
    const res = await fetch(serverUrl + '/people');
    const users = await res.json();
    const sel = $('userSelect'); sel.textContent = '';
    const def = document.createElement('option'); def.value=''; def.textContent='Select a user'; sel.appendChild(def);
    Object.keys(users).sort((a,b)=>a.localeCompare(b)).forEach(name=>{
      const opt=document.createElement('option'); opt.value=name; opt.textContent=name; sel.appendChild(opt);
    });
  }

  function makeRow(name, price){
    const row = document.createElement('div'); row.className='row';

    const left = document.createElement('div');
    const n = document.createElement('div'); n.className='name'; n.textContent=name;
    const p = document.createElement('div'); p.className='price'; p.textContent=`Price: ${price}`;
    left.append(n,p);

    const controls = document.createElement('div'); controls.className='controls';
    const minus = document.createElement('button'); minus.className='btn'; minus.type='button'; minus.textContent='−'; minus.setAttribute('aria-label',`Decrease ${name}`);
    const input = document.createElement('input'); input.className='qty'; input.inputMode='numeric'; input.pattern='[0-9]*'; input.type='number'; input.min='0'; input.step='1'; input.value='0'; input.id='q_'+safeId(name);
    const plus = document.createElement('button'); plus.className='btn'; plus.type='button'; plus.textContent='+'; plus.setAttribute('aria-label',`Increase ${name}`);

    function setQty(val){ const v = Math.max(0, Number(val)||0); input.value=String(v); quantities[name]=v; updateTotals(); }
    minus.addEventListener('click',()=> setQty(Number(input.value)-1));
    plus.addEventListener('click',()=> setQty(Number(input.value)+1));
    input.addEventListener('input',()=> setQty(input.value));

    controls.append(minus,input,plus);
    row.append(left,controls);
    return row;
  }

  async function loadProducts() {
    const res = await fetch(serverUrl + '/products');
    products = await res.json();
    const list = $('productList'); list.textContent='';
    quantities = {};
    Object.keys(products).sort((a,b)=>a.localeCompare(b)).forEach(name=>{
      const price = products[name].price || 0;
      list.appendChild(makeRow(name, price));
      quantities[name] = 0;
    });
    updateTotals();
    const first = list.querySelector('.qty'); if(first) first.focus({preventScroll:true});
  }

  $('userSelect').addEventListener('change', async (e)=>{
    const name = e.target.value;
    if (!name) { selectedUser=''; balance=0; $('userName').textContent='—'; $('userBalance').textContent='—'; updateTotals(); return; }
    const res = await fetch(serverUrl + '/people/' + encodeURIComponent(name));
    if (res.ok) {
      const data = await res.json();
      selectedUser = name; balance = data[name] ?? 0;
      $('userName').textContent = name; $('userBalance').textContent = balance;
    } else { selectedUser=''; balance=0; $('userName').textContent='—'; $('userBalance').textContent='—'; }
    updateTotals();
  });

  function updateTotals() {
    let total=0;
    for (const [name, q] of Object.entries(quantities)) {
      const qty = Math.max(0, Number(q)||0);
      const price = (products[name]?.price)||0;
      total += qty * price;
    }
    $('totalPrice').textContent = total;
    const after = selectedUser ? (balance - total) : null;
    $('updatedBalance').textContent = (after===null ? '—' : (after>=0 ? after : 'Insufficient'));
    $('buyButton').disabled = !selectedUser || total<=0 || (after!==null && after<0);
  }

  function resetForNextSale(){
    for(const n of Object.keys(quantities)) quantities[n]=0;
    document.querySelectorAll('.qty').forEach(i=> i.value='0');
    updateTotals();
    const first = document.querySelector('.qty'); if(first) first.focus({preventScroll:true});
    showToast();
  }

  $('buyButton').addEventListener('click', async ()=>{
    const items = {};
    for (const [name, q] of Object.entries(quantities)) {
      const qty = Math.max(0, Number(q)||0);
      if (qty>0) items[name]=qty;
    }
    if (!selectedUser || Object.keys(items).length===0) return;
    const res = await fetch(serverUrl + '/order', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ name: selectedUser, items })
    });
    if (res.ok){
      const j = await res.json();
      balance = j.balance; $('userBalance').textContent = balance;
      resetForNextSale();
    } else {
      console.error('Order failed', await res.text());
    }
  });

  // Init
  loadUsers(); loadProducts();
</script>
</body>
</html>
