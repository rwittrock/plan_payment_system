<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Team POS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f7f7f7;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 420px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .1);
        }

        h1,
        h2 {
            text-align: center;
        }

        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
        }

        .product-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
            border: 1px solid #ececec;
            border-radius: 10px;
            padding: 10px;
            background: #fafafa;
        }

        .name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .price {
            color: #666;
            font-size: 14px;
        }

        .controls {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .controls button {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: #fff;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
        }

        .controls input {
            width: 64px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 8px;
            text-align: center;
            font-size: 16px;
        }

        button {
            width: 100%;
            padding: 12px;
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 16px;
        }

        button:disabled {
            background: #aaa;
            cursor: not-allowed;
        }

        .toast {
            position: fixed;
            left: 50%;
            top: 16px;
            transform: translateX(-50%);
            background: #111;
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            pointer-events: none;
            transition: opacity .25s;
            box-shadow: 0 6px 18px rgba(0, 0, 0, .2);
            z-index: 9999
        }

        .toast.show {
            opacity: 1
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Team Balance</h1>
        <select id="userSelect">
            <option value="">Select team member</option>
        </select>
        <p><strong>Name:</strong> <span id="userName">—</span></p>
        <p><strong>Balance:</strong> <span id="userBalance">—</span></p>

        <h2>Team Products</h2>
        <div id="productList" class="product-list"></div>

        <p>Total: <span id="totalPrice">0</span></p>
        <p>Updated Balance: <span id="updatedBalance">—</span></p>
        <button id="buyButton" disabled>Buy Products</button>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite">Purchase recorded</div>

    <script>
        const serverUrl = location.origin;
        const safeId = s => s.toLowerCase().replace(/[^a-z0-9]+/g, '_');
        let selectedUser = '', balance = 0, products = {}, quantities = {};

        function showToast(msg = 'Purchase recorded') {
            const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 1200);
        }
        async function loadUsers() {
            const r = await fetch(serverUrl + '/team_people'); const users = await r.json();
            const sel = document.getElementById('userSelect'); sel.textContent = '';
            const def = document.createElement('option'); def.value = ''; def.textContent = 'Select team member'; sel.appendChild(def);
            Object.keys(users).sort().forEach(n => { const o = document.createElement('option'); o.value = n; o.textContent = n; sel.appendChild(o); });
        }
        async function loadProducts() {
            const r = await fetch(serverUrl + '/team_products'); products = await r.json();
            const list = document.getElementById('productList'); list.textContent = ''; quantities = {};
            Object.keys(products).sort((a, b) => a.localeCompare(b)).forEach(name => {
                const price = products[name].price || 0;
                const row = document.createElement('div'); row.className = 'row';
                const left = document.createElement('div');
                const n = document.createElement('div'); n.className = 'name'; n.textContent = name;
                const p = document.createElement('div'); p.className = 'price'; p.textContent = `Price: ${price}`;
                left.append(n, p);

                const controls = document.createElement('div'); controls.className = 'controls';
                const minus = document.createElement('button'); minus.type = 'button'; minus.textContent = '−';
                const input = document.createElement('input'); input.autocomplete = 'off'; input.type = 'number'; input.min = '0'; input.value = '0'; input.id = 'q_' + safeId(name);
                const plus = document.createElement('button'); plus.type = 'button'; plus.textContent = '+';

                function setQty(val) { const v = Math.max(0, Number(val) || 0); input.value = String(v); quantities[name] = v; updateTotals(); }
                minus.addEventListener('click', () => setQty(Number(input.value) - 1));
                plus.addEventListener('click', () => setQty(Number(input.value) + 1));
                input.addEventListener('input', () => setQty(input.value));

                controls.append(minus, input, plus);
                row.append(left, controls);
                list.appendChild(row);

                quantities[name] = 0;
            });
            updateTotals();
            const firstInput = list.querySelector('.controls input'); if (firstInput) firstInput.focus({ preventScroll: true });
        }
        async function onUserChange(n) {
            if (!n) { selectedUser = ''; balance = 0; document.getElementById('userName').textContent = '—'; document.getElementById('userBalance').textContent = '—'; updateTotals(); return; }
            const r = await fetch(serverUrl + '/team_people/' + encodeURIComponent(n));
            if (r.ok) { const d = await r.json(); selectedUser = n; balance = d[n]; document.getElementById('userName').textContent = n; document.getElementById('userBalance').textContent = balance; }
            updateTotals();
        }
        function updateTotals() {
            let total = 0;
            for (const [name, q] of Object.entries(quantities)) { const qty = Math.max(0, Number(q) || 0); total += qty * ((products[name]?.price) || 0); }
            document.getElementById('totalPrice').textContent = total;
            const after = selectedUser ? (balance - total) : null;
            document.getElementById('updatedBalance').textContent = after === null ? '—' : (after >= 0 ? after : 'Insufficient');
            document.getElementById('buyButton').disabled = !selectedUser || total <= 0 || (after !== null && after < 0);
        }
        document.getElementById('userSelect').addEventListener('change', e => onUserChange(e.target.value));

        function resetForNextSale() {
            for (const n of Object.keys(quantities)) quantities[n] = 0;
            document.querySelectorAll('.controls input').forEach(i => i.value = '0');
            updateTotals();
            const first = document.querySelector('.controls input'); if (first) first.focus({ preventScroll: true });
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showToast();
        }

        document.getElementById('buyButton').addEventListener('click', async () => {
            const items = {}; for (const [name, q] of Object.entries(quantities)) { const qty = Math.max(0, Number(q) || 0); if (qty > 0) items[name] = qty; }
            if (!selectedUser || Object.keys(items).length === 0) return;
            const r = await fetch(serverUrl + '/team/order', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: selectedUser, items }) });
            if (r.ok) { const j = await r.json(); balance = j.balance; document.getElementById('userBalance').textContent = balance; resetForNextSale(); }
            else { console.error('Team order failed', await r.text()); }
        });
        loadUsers(); loadProducts();
    </script>
</body>

</html>